這份對照分析非常精確，清楚地指出了目前專案「以區塊替換模擬編輯」的策略優勢（實作快、邏輯簡單）與劣勢（缺乏排版流動性、忽略變形）。

基於您的分析與 `PyMuPDF` 的特性，我將建議分為 **「高優先級（修正視覺與相容性錯誤）」** 與 **「中長期優勢（提升編輯器品質）」** 兩部分提出具體建議。

---

### 一、高優先級：建議立即加入的技術與修改

這些項目能解決「編輯後文字變形」或「換電腦後缺字/亂碼」的硬傷。

#### 1. 加入「座標變換矩陣 (CTM)」處理（修正旋轉/傾斜失效）

* **現狀問題**：目前的流程是「取 `rect` → 清除 → 寫入正向文字」。若原文字是垂直書寫、旋轉 90 度或有傾斜效果，編輯後會變成「水平正向」文字，破壞版面。
* **建議修改**：
1. **讀取階段**：在 `page.get_text("dict")` 取得 span 時，不要只讀 `rect`，要讀取其 **`matrix`** 或 **`origin`**（原點）與 **`dir`**（方向向量）。
2. **寫入階段**：`insert_htmlbox` 支援 `rotate` 參數（旋轉角度）。您需要計算原文字的旋轉角度傳入。


* *進階*：若文字有傾斜（Shear），`htmlbox` 可能不支援，需改用 `insert_text` 配合 `morph` 參數來達成仿射變換。



#### 2. 改進「字體嵌入與子集」策略（解決缺字/亂碼）

* **現狀問題**：目前僅區分 CJK / 英文。若使用者輸入原 PDF 字體子集（Subset）中不存在的字（例如原檔只有「台」，使用者改成「灣」），且系統無對應字體，會顯示豆腐塊或亂碼。
* **建議修改**：
1. **字體偵測**：檢查原 span 的字體是否為 Embedded Subset。如果是，直接放棄使用原字體名稱。
2. **全字庫嵌入**：建立一個標準的 Fallback 字體機制（如內建 Noto Sans CJK 字型檔）。編輯時，強制將新文字方塊的字體設為該本地字體，並在 `save` 時確保嵌入（PyMuPDF 預設會嵌入新字體）。這能確保檔案傳到別台電腦時，修改過的文字依然可讀。



#### 3. 實作「增量更新 (Incremental Update)」選項

* **現狀問題**：目前 `save(garbage=0)` 會重寫檔案結構。如果原檔有數位簽章，簽章會直接失效（雖然編輯文字本質上就會破壞簽章，但增量更新是破壞性最小的）。此外，對於大檔案，重寫所有物件效率較低。
* **建議加入**：
* 提供 `save(incremental=True)` 選項。雖然 `add_redact_annot` + `apply_redactions` 本質上是重寫內容流，但 PyMuPDF 支援將這些變更以增量方式附加在檔尾。這對於大型圖紙或百頁報告的編輯存檔速度會有顯著提升。



---

### 二、中長期優勢：建議增強的功能

這些功能能讓您的工具從「修改文字的腳本」進化為「真正的編輯器」。

#### 1. 引入簡單的「內容流對齊算法」（模擬 Reflow）

* **痛點**：現在字數變多時，文字會自動縮小或被切掉（視 `insert_htmlbox` 設定而定），不會把下方的段落「往下推」。
* **建議實作**：
* **碰撞檢測 (Collision Detection)**：編輯前，先計算新 `rect` 與同一頁其他 blocks 的 `rect` 是否重疊。
* **垂直推移**：若新文字高度增加，計算出 `delta_y`，將所有 `y` 座標大於目標區塊的 blocks 向下移動 `delta_y`（這需要修改那些 blocks 的 content stream 座標，技術門檻較高，但 PyMuPDF 可透過 `page.set_text_matrix` 或重寫 blocks 達成）。



#### 2. 文字屬性的精細化讀取

* **現狀**：只讀 `font`, `size`, `color`。
* **建議加入**：
* **Char flags (粗體/斜體)**：`get_text("dict")` 的 span 中有 `flags` 屬性。讀取它，並在生成 CSS 時加入 `font-weight: bold` 或 `font-style: italic`，還原度會大幅提升。
* **對齊方式 (Alignment)**：目前 HTML 可能是預設左對齊。您可以透過分析 lines 內 spans 的分佈（靠左、居中或靠右），推算出原塊的 `text-align` 屬性並寫入 CSS。



#### 3. 混合模式處理 (Blend Mode / Transparency)

* **現狀**：如果文字下方有圖片，Redaction 預設會塗白（或是透明）。
* **建議修改**：
* 確保 Redaction 的填色設為透明（除非使用者想蓋掉背景）。
* 注意 `insert_htmlbox` 的背景色設定，確保編輯後的文字能像原文字一樣「浮」在背景圖之上，而不是貼了一塊白色補丁。



---

### 三、總結建議清單

若資源有限，建議優先執行的 **Action Items**：

| 優先順序 | 修改模組 | 技術關鍵 | 目的 |
| --- | --- | --- | --- |
| **P0 (Bug)** | 建立索引 / 寫入 | **Matrix / Rotate** | 讓垂直/旋轉文字編輯後不會變回水平。 |
| **P1 (穩定性)** | 字體處理 | **Font Embedding** | 防止編輯後出現亂碼（豆腐字）。 |
| **P1 (還原度)** | `_convert_text_to_html` | **Span Flags** | 保留粗體、斜體樣式。 |
| **P2 (效能)** | 存檔流程 | **Incremental Save** | 加速大檔存檔，保留檔案歷史結構。 |

**您是否希望我針對「如何讀取 Span 的 Matrix 並應用到 `insert_htmlbox`」提供 PyMuPDF 的程式碼範例？**