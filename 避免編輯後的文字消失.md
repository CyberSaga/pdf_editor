# 避免編輯後的文字消失

## 現象

編輯某段文字後，畫面上該段文字不見了；log 可能顯示「編輯文字成功」或 `scale_used=1.0`，但 PDF 上對應區塊為空白。

---

## 根本原因

### 1. insert_htmlbox 在「塞不下」時不繪製

- `insert_htmlbox(rect, html_content, ..., scale_low=1)` 會先嘗試把內容排進 `rect`。
- 若引擎判定**塞不下**，會回傳 **`spare_height=-1`**，且**不會在頁面上畫任何東西**。
- 流程是：先 `add_redact_annot` + `apply_redactions` 清除原文字 → 再 `insert_htmlbox`。若此時回傳 -1，就變成「已清除、未重繪」→ **編輯後的文字消失**。

### 2. 垂直文字 (rotate=270) 特別容易回傳 -1

- 使用 `insert_htmlbox(..., rotate=270)` 時，引擎的「塞入」判定與一般不同。
- 即使已把 rect 加大（例如 2 倍頁高、或依旋轉後尺寸給正方形 rect），垂直文字仍常得到 **spare_height=-1**。
- 因此若**只**用 `scale_low=1` 且沒有 fallback，垂直編輯很容易出現「成功 log、畫面卻空白」。

### 3. rect 過大或形狀改變會導致「畫在錯誤位置」（scale_used=1.0 仍消失）

- 為讓 scale_low=1 通過，曾改為給很大的 rect（例如正方形 `used_side × used_side`）。
- 若 rect 的**位置或範圍**與原區塊不一致，旋轉 270° 後內容可能畫在**頁面外或錯誤位置**，log 雖顯示 `scale_used=1.0`、編輯成功，但使用者看不到該段文字（看起來仍像「消失」）。
- **結論**：垂直文字應維持「窄×高」rect（與原區塊同寬、只擴高），**不要**改成正方形或大幅擴寬；塞不下時依賴 **scale_low=0 fallback** 繪出，才能保證畫在正確位置。

---

## 解決要點（防止再次發生）

### 1. 垂直文字必須有「塞不下」時的 fallback

- **不可**在垂直文字 (rotation 90/270) 時，僅依 `spare_height < 0` 就報錯或直接結束而不畫任何內容。
- 當 `spare_height < 0` 時，**至少要**再呼叫一次 `insert_htmlbox(..., scale_low=0)`，讓內容無論如何都會被畫出來（字級可能略縮，但不會消失）。
- 若拿掉或關閉此 fallback，垂直編輯很容易再次出現「編輯後文字消失」。

### 2. 不要依賴「只試一次 scale_low=1」就成功

- 垂直文字在目前實作下，**第一次** `insert_htmlbox(..., scale_low=1)` 常回傳 -1。
- 若程式只試一次、且失敗時不畫，就會重現「清除後未重繪」的 bug。
- 正確做法：`spare_height < 0` 時要有明確的 fallback（例如 scale_low=0），**不要**只 log 或 raise 而不繪製。

### 3. rect 要兼顧「足夠大」與「位置正確」——垂直時用「窄×高」、不改成正方形

- 給 rect 時若只顧「放大」以通過 fit（例如過大正方形），旋轉後內容可能偏離原區塊，log 雖 scale_used=1.0 仍會「消失」。
- **垂直文字**：應維持與原區塊**同寬**（不擴寬）、只擴**高度**的 rect（窄×高）；若 spare_height=-1，一律用 **scale_low=0** fallback 繪出，以保證畫在正確位置。
- 水平文字：可依行數擴展寬高，不受此限。

### 4. 修改相關程式時的檢查清單

- [ ] 是否有呼叫 `insert_htmlbox` 且使用 `scale_low=1`？
- [ ] 當 `spare_height < 0` 時，是否有**至少一種**會實際繪製的 fallback（例如 scale_low=0）？
- [ ] 垂直文字 (90/270) 路徑是否**一定**會執行到該 fallback，不會只報錯就結束？
- [ ] 若調整 rect 大小或形狀，是否確認過旋轉後內容仍在**可見且正確**的位置？

---

## 相關程式位置（pdf_model.py）

- **edit_text**：單一文字框編輯；內有 `insert_htmlbox`、`spare_height` 檢查與垂直文字 fallback。
- **_render_text_blocks_from_index**：從索引重繪整頁；同樣有 `insert_htmlbox` 與 spare_height 處理。
- 關鍵邏輯：`if spare_height < 0` 且 `rotation in (90, 270)` 時，必須再呼叫 `insert_htmlbox(..., scale_low=0)`，避免該區塊空白。

---

## 簡短結論

1. **insert_htmlbox 回傳 spare_height=-1 時不會畫任何東西**，會導致「編輯後文字消失」。
2. **垂直文字**特別容易回傳 -1，因此**必須**在 spare_height&lt;0 時用 scale_low=0 再畫一次。
3. rect 要**足夠大**也要**位置合理**，避免旋轉後畫到頁外或錯位。
4. 日後改動時請依上方檢查清單確認，避免移除或繞過 fallback 而重現「消失」問題。
