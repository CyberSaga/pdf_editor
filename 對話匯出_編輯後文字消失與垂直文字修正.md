# 對話匯出：編輯後文字消失與垂直文字修正

本文檔為本次對話的完整匯出，記錄 PDF 文字編輯器中「編輯後文字消失」、垂直文字旋轉/縮放、以及相關修正與防範文件的建立過程。

---

## 一、使用者需求（依序）

1. **加入 CTM（座標變換矩陣）**：編輯非水平文字時保留原文字方向（旋轉/垂直），參考「高優先級…建議.md」第 11–19 行。
2. **修正垂直文字 180° 反轉與超出框**：編輯後不要整行反轉、不要超出文字框。
3. **保留位置、修正截斷與空格**：編輯後不右移、不與前一行重疊；「some song.」不要被截成「somesc」；空格要顯示。
4. **換行時不縮小字級**：有換行時字級不要變小。
5. **行高不夠時拓寬文字框**：用「重新計算行高、拓寬框」取代縮小字級。
6. **參考 pdf_editor_old 做法**：對齊「寬度拓展至頁面右邊界、高度依換行數計算」的邏輯。
7. **編輯後文字消失**：多次出現「編輯成功」但畫面上該段文字不見；要求找出原因並修復。
8. **失敗時不縮小字級**：塞不下時改為輸出失敗原因，不要用 scale_low=0 縮小字級。
9. **全部用 HTML 渲染**：不依文字框截斷或縮小字級；後來因仍失敗而對垂直文字加回 scale_low=0 fallback。
10. **釐清「先算大小還是先轉向」**：確認 insert_htmlbox(rotate=270) 是「先排版再旋轉、再依旋轉後內容塞進 rect 決定縮放」；並改為依「旋轉後所需寬高」給 rect（正方形 used_side）以減少字級壓縮。
11. **字級仍縮太多**：scale_low=0 時約 0.5；要求確認是「先算大小再轉向」還是「先轉向再算幾倍行高」。
12. **編輯後文字再次消失**：即使用正方形 rect 得到 scale_used=1.0、log 顯示成功，畫面上文字仍消失。要求把問題與防範寫成文件「避免編輯後的文字消失.md」。

---

## 二、已完成的修改（皆在 `model/pdf_model.py`）

### CTM / 旋轉

- 從 `get_text("dict")` 的 line 讀取 `dir`，用 `_rotation_degrees_from_dir` 算出 0/90/180/270。
- 索引與 `_get_text_blocks_in_rect` 的 block 都存 `rotation`。
- `_insert_rotate_for_htmlbox(rotation)` 用 `(360 - rotation) % 360` 修正 180° 反轉。
- 呼叫 `insert_htmlbox(..., rotate=insert_rotate)` 時一併傳入上述旋轉。

### 垂直文字 rect

- 曾試過：寬高交換、不交換只用原 bbox、2 倍頁高、依旋轉後尺寸給正方形 `used_side`。
- **目前**：垂直時維持「**窄×高**」rect（與原區塊同寬、只擴高），避免旋轉後畫錯位置導致「消失」；塞不下時靠 **scale_low=0 fallback** 繪出。

### 空格

- `_convert_text_to_html` 中空格改為包在 `<span style="font-family: helv;">&#160;...</span>` 內，避免旋轉/窄框下被壓成零寬。

### 換行與框高

- 水平：`estimated_height = line_count * size * 1.5 + size`，寬度 `max_allowed_width = page_width - x0 - margin`。
- 垂直：`logical_lines`、`wrap_lines`、`num_lines`，再算 `layout_height_pt` 與擴高後的 `used_height`。

### scale_low 與 fallback

- 一律先 `insert_htmlbox(..., scale_low=1)`。
- 若 `spare_height < 0` 且 `rotation in (90, 270)`：再呼叫一次 `insert_htmlbox(..., scale_low=0)` 以保留富文本/CJK，避免「編輯後文字消失」。
- 若非垂直且 spare_height < 0：僅記錄錯誤並 raise，不縮小字級。

### 文件

- 新增 **`避免編輯後的文字消失.md`**，說明：insert_htmlbox 在 spare_height=-1 時不繪製、垂直易回傳 -1、rect 過大可能導致錯位、必須保留 scale_low=0 fallback 及檢查清單。

---

## 三、關鍵檔案與位置

| 項目 | 路徑 / 說明 |
|------|-------------|
| 模型主邏輯 | `model/pdf_model.py` |
| 索引建立、rotation | `_build_text_block_index`：讀 line 的 `dir`，存 `rotation` |
| 旋轉換算 | `_rotation_degrees_from_dir`、`_insert_rotate_for_htmlbox` |
| 區塊查詢 | `_get_text_blocks_in_rect`：回傳 block 含 `rotation` |
| 空格處理 | `_convert_text_to_html`：空格用 `&#160;` + helv span |
| 編輯時 rect 與 fallback | `edit_text`：計算 html_rect（水平/垂直）、`insert_htmlbox`、spare_height&lt;0 時垂直用 scale_low=0 fallback |
| 還原時渲染 | `_render_text_blocks_from_index`：同上 rect 與 fallback 邏輯 |
| 防範文件 | `避免編輯後的文字消失.md`（專案根目錄） |

---

## 四、遇到的問題與處理方式

| 問題 | 處理方式 |
|------|----------|
| 垂直文字 180° 反轉 | 改傳 `insert_rotate = (360 - rotation) % 360` |
| 位置右移、與前一行重疊 | 垂直時不再做寬高交換，維持窄×高 rect |
| 只顯示「so」、空格不見 | 空格包在 helv span + `&#160;` |
| 換行時字級縮小 | 對 insert_htmlbox 加上 `scale_low=1` |
| 拓寬後仍塞不下、區塊消失 | 改為「垂直時 scale_low=0 fallback」；非垂直則 raise 不縮小字級 |
| scale_low=0 時字級約 0.5 | 曾改正方形 rect；後因「消失」改回窄×高 + fallback |
| **scale_used=1.0 仍「編輯後文字消失」** | 判定為 rect 過大（正方形）導致旋轉後內容畫在錯誤位置；改回**窄×高** rect，並在文件中明寫「垂直時不改成正方形」 |

---

## 五、防範要點（摘自「避免編輯後的文字消失.md」）

1. **insert_htmlbox 在 spare_height=-1 時不繪製**：必須檢查回傳值，&lt;0 時要 fallback 或報錯。
2. **垂直文字常回傳 -1**：窄×高時易塞不下，需保留 **scale_low=0** 的 fallback 以保證有繪製。
3. **rect 過大或形狀改變會導致畫在錯誤位置**：垂直時應維持「窄×高」、**不要**改成正方形或大幅擴寬；否則旋轉後內容可能畫在頁外或錯位，log 雖 scale_used=1.0 仍會「消失」。
4. **檢查清單**：spare_height 檢查、垂直 fallback、rect 位置與形狀（窄×高）、索引與還原邏輯一致。

---

## 六、尚未完全解決與後續建議

- **字級在 scale_low=0 時仍可能偏小**：在「不消失」為優先的前提下，目前以窄×高 + fallback 保證位置正確；若需進一步減少縮放，可查 PyMuPDF 文件/原始碼，確認 insert_htmlbox(rotate=270) 對 rect 的解釋（旋轉中心與 rect 的關係）。
- **待後續驗證**：垂直文字時 rect 的**錨點與旋轉中心**；是否可「只擴高、不擴寬」再微調 used_height 以在 scale_low=1 下通過，同時不導致錯位。

---

## 七、給接手者的建議

1. 先讀 **`避免編輯後的文字消失.md`** 與 **`model/pdf_model.py`** 中 `edit_text` 的 rect 計算及 `spare_height < 0` 的 fallback。
2. 重點釐清：**旋轉 270° 時，insert_htmlbox 的 rect 是「排版用」還是「旋轉後要 fit 的目標」、旋轉中心在哪**。
3. 維持「垂直用窄×高、不改成大正方形」及「保留 scale_low=0 fallback」，以兼顧「不消失」與「盡量不縮小字級」。

---

*匯出時間：依本對話內容整理。*
