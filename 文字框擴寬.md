# 文字框擴寬與垂直文字問題整理

## 垂直文字常常「消失」或被裁切
- 問題描述：PyMuPDF 在垂直時 `insert_htmlbox` 常回傳 `spare_height = -1`，如果直接只放 `scale_low=1` 就會跳過渲染；換成大 rect 又會讓旋轉後的文字跑掉或和其他欄衝突。
- 技術細節：
  - 先用窄×高 rect 嘗試 `scale_low=1`，若 `spare_height < 0` 再用 `scale_low=0` 重畫，確保有字可見；詳細位於 `model/pdf_model.py` 內 `edit_text` 與 `_render_text_blocks_from_index` 的 `insert_htmlbox` 呼叫。
  - 垂直字的 rect 只在 x 方向往左延伸（`_vertical_html_rect`）並以「第一行」為 anchor，避免先前正方形 rect 造成旋轉後錯位。

## 垂直框擴寬會撞到左側欄、導致重疊
- 問題描述：向左延伸的 rect 會侵入前一欄，造成「字被覆蓋」或在全頁渲染時互相蓋住。
- 技術細節：
  - 索引裡新增 `layout_rect`（與原始 `rect` 分離），每次渲染都用 `layout_rect` 表示實際版面位置。
  - edit 時若目標 rect 向左侵犯，就找出所有左側垂直欄（同一 y 範圍、rotation 90/270、x1 距離小於 4pt），依序往左移動，並更新 `layout_rect`，最後一起重繪。
  - 變動後會用 `temp_page.redact` 拋掉舊位置、`insert_htmlbox` 重新畫出，詳見 `edit_text` 中 collision loop。

## 同一行加長仍被截斷
- 問題描述：單欄內容變長後，x 寬不足，`scale_low=1` 還是會把字裁掉，只用 y 高擴展無法解決。
- 技術細節：
  - 先把 rect 的 y1 拉到 `page.rect.y1`（只保留原始 `y0`），再用 `_binary_shrink_height` 透過 `get_text(clip=rect)` 判斷文字是否完整。
  - 使用二分法收斂 y1，最多 7 次並加 4pt padding，讓 rect 限縮到剛好包住文字；失敗則報錯。
  - 這套流程在 `_render_text_blocks_from_index` 與 `edit_text` 垂直分支都採用，以保持一致。

## 文字框起點被拉到頁面頂端
- 問題描述：前述「全頁高度」流程把 y0 設成 `page.y0`，導致文字跑到頁首，看起來整個段落被往上抬。
- 技術細節：
  - 垂直文字初始 rect 現在以原始 block 的 `y0` 為起點，只在 `y1` 拉到頁面頂端。
  - 二分縮減時也固定 `y0 = rect.y0`，保證首字永遠在原位置的右上角，水平文字仍維持左上。

## 空格在狹窄欄位消失或換行亂掉
- 問題描述：空格在旋轉+窄框下會被壓成 0 寬，導致「some song」變成「somesc」。
- 技術細節：
  - `_convert_text_to_html` 保留 `&#160;`，並在每個空格後加上 `<wbr>`，提供斷行點但仍維持可視寬度。
  - normalized 比對文字（`re.sub(r'\s+', '', …).lower()`）用於 `_text_fits_in_rect`，避免縮減後漏判。

## 建議追蹤
1. 以範例 PDF 測試垂直換行、左欄碰撞與 x 寬擴展，確保未來修改不回退。
2. 若想更精細控制，考慮用 `insert_htmlbox` 的 `bbox` + `morph` 方式重畫單行，但目前 HTML not supported。
