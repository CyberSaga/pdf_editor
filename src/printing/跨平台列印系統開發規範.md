這是一份針對 Python PDF 編輯器量身打造的**跨平台列印系統開發規範**。本規範採用「工廠模式」架構，確保程式碼具備高維護性，同時針對 PDF 渲染效能進行優化。

---

## 1. 系統架構與邊界 (System Architecture)

我們將採用 **抽象介面層 (Abstract Layer)** 隔離平台差異，並使用 **分頁非同步渲染 (Asynchronous Page Rendering)** 提升效能。

### 核心組件邊界

* **Document 提供者**：僅接受本地 PDF 路徑或 `bytes` 流。
* **渲染引擎**：統一使用 `PyMuPDF (fitz)`，因其渲染速度比 `pdf2image` 快 5-10 倍。
* **平台轉發器**：
* **Windows**: 透過 `pywin32` 調用 GDI 繪圖。
* **macOS/Linux**: 透過 `pycups` 或系統 `lp` 指令提交 PDF/PostScript 任務。



---

## 2. 開發規格 (Technical Specifications)

### A. 檔案結構 (Project Structure)

```text
src/printing/
├── __init__.py          # 工廠入口：get_printer_driver()
├── base_driver.py       # 抽象基類：定義所有驅動必須實作的方法
├── pdf_renderer.py      # 渲染核心：使用 PyMuPDF 將 PDF 轉為 QImage/點陣數據
└── platforms/
    ├── win_driver.py    # Windows GDI 實作 (pywin32)
    ├── mac_driver.py    # macOS CUPS 實作 (pycups)
    └── linux_driver.py  # Linux CUPS 實作 (pycups)

```

### B. 效能優化指標 (Performance Benchmarks)

1. **記憶體管理**：禁止一次性將整份 PDF 轉為圖片。必須採用「**隨印隨解 (On-demand Rendering)**」，即當印表機準備好接收下一頁時，才從 `PyMuPDF` 提取該頁。
2. **解析度自適應**：
* 預覽模式：72 - 96 DPI。
* 正式列印：根據印表機硬體解析度（通常為 300 或 600 DPI）動態計算矩陣。


```python
# 高效渲染範例
zoom = dpi / 72  # 72 是 PDF 標準解析度
matrix = fitz.Matrix(zoom, zoom)
pix = page.get_pixmap(matrix=matrix, colorspace=fitz.csRGB)

```



---

## 3. 跨平台實作邏輯 (Implementation Logic)

### 1. Windows 實作 (Win32 GDI)

* **機制**：建立一個 Device Context (DC)，將渲染後的點陣圖透過 `BitBlt` 或 `StretchDIBits` 繪製到印表機畫布。
* **依賴**：`pywin32` (win32print, win32ui, win32con)。

### 2. macOS & Linux 實作 (CUPS)

* **機制**：由於 macOS 與 Linux 核心列印系統皆為 CUPS，且原生支援 PDF 直接輸出，不需逐頁轉圖。
* **操作**：直接呼叫 `cups.Connection().printFile()`，由系統後端處理 PPD 轉換。
* **優勢**：速度極快，且保留向量字體清晰度。

---

## 4. 邊界與異常處理 (Error Handling Boundaries)

| 邊界場景 | 處理規範 |
| --- | --- |
| **印表機離線** | 驅動層必須在提交任務前檢查 `get_status()`，若失敗需拋出 `PrinterOfflineError`。 |
| **紙張不匹配** | 提供 `ScaleToFit` 選項，自動計算 PDF MediaBox 與 Printer PaperBox 的比例，進行等比例縮放。 |
| **字體未嵌入** | 在 `pdf_renderer` 層級強制進行「文字轉路徑 (Text-to-Path)」渲染，確保列印結果與螢幕一致。 |
| **打包依賴** | 在 `setup.py` 或 `requirements.txt` 使用 Environment Markers，避免 Windows 使用者裝到 `pycups`。 |

---
