# 問題大全：反覆卡住的問題、嘗試的解法與失敗／新問題

本文檔記錄 PDF 文字編輯器開發中**反覆卡住的問題**、**嘗試過的解決方式**、以及**解法為何失敗或又導致了什麼新問題**，供日後避免重蹈覆轍。

---

## 一、編輯後文字「消失」（log 成功、畫面上不見）

### 現象

- 編輯垂直文字後，log 顯示「編輯文字成功」或 `scale_used=1.0`，但 PDF 上該區塊為**空白**，使用者看不到剛編輯的內容。

### 嘗試的解法與失敗／新問題

| 嘗試 | 做法 | 結果／新問題 |
|------|------|--------------|
| 1 | 未特別處理 `insert_htmlbox` 回傳值 | **失敗**：`insert_htmlbox` 在「塞不下」時回傳 `spare_height=-1` 且**不繪製**；流程是「先清除原文字 → 再 insert_htmlbox」，回傳 -1 就變成「已清除、未重繪」→ 文字消失。 |
| 2 | 塞不下時改為「輸出失敗原因、不縮小字級、不畫」 | **失敗**：垂直文字**常**回傳 -1，若一律不畫，垂直編輯幾乎每次都會「消失」，使用者體驗更差。 |
| 3 | 對垂直文字加回 **scale_low=0** fallback（spare_height&lt;0 時再畫一次） | **有效**：至少會畫出內容，不再「消失」。但引出下一個問題：字級被縮小。 |
| 4 | 為讓 scale_low=1 通過，把垂直文字的 rect 改成**正方形**（used_side×used_side），依旋轉後所需寬高計算 | **新問題**：log 顯示 `scale_used=1.0`、編輯成功，但**畫面上文字仍消失**。原因：rect 過大／形狀改變後，旋轉 270° 的內容被畫在**錯誤位置或頁外**，使用者看不到。 |
| 5 | 改回**窄×高** rect（與原區塊同寬、只擴高），保留 scale_low=0 fallback | **目前做法**：位置正確、不會消失；但窄×高時常塞不下，仍常走 fallback，字級可能被縮小（見下節）。 |

### 結論

- **消失**的根因：`spare_height=-1` 時不繪製 ＋ 垂直文字易回傳 -1 ＋ 曾用過大 rect 導致旋轉後錯位。
- **必須**：檢查 spare_height、垂直時保留 scale_low=0 fallback、rect 用窄×高不改成正方形。詳見 `避免編輯後的文字消失.md`。

---

## 二、字級被縮小太多（scale_low=0 時約 0.5）

### 現象

- 垂直文字塞不進 rect 時改用 scale_low=0，字級被明顯縮小（例如 scale_used≈0.5），使用者不滿意。

### 嘗試的解法與失敗／新問題

| 嘗試 | 做法 | 結果／新問題 |
|------|------|--------------|
| 1 | 一律 **scale_low=1**，塞不下就報錯不畫 | **失敗**：垂直文字常塞不下，導致「編輯後文字消失」（見上一節）。 |
| 2 | 拓寬／加高 rect：例如 2 倍頁高、或依「旋轉後所需寬高」給更大的 rect | **部分有效**：有時 scale_low=1 能通過。但若**擴太大**（例如改成正方形），又導致旋轉後**畫在錯誤位置**，出現「scale_used=1.0 仍消失」（見上一節）。 |
| 3 | 依旋轉後所需尺寸給**正方形** rect（used_side），讓 scale=1 通過 | **新問題**：scale_used=1.0 但**文字消失**——正方形 rect 改變了繪製範圍，旋轉後內容錯位。 |
| 4 | 維持窄×高 rect ＋ scale_low=0 fallback | **目前取捨**：優先保證「不消失」與「位置正確」；字級在 fallback 時仍可能偏小，尚未完全解決。 |

### 結論

- 字級與「不消失」存在張力：要 scale=1 常需大 rect，大 rect 又易導致垂直旋轉後錯位。
- 目前以**窄×高 ＋ fallback** 為穩妥方案；若要進一步減少縮放，需釐清 PyMuPDF `insert_htmlbox(rotate=270)` 的 rect 語意與旋轉中心，再考慮「只擴高、不擴寬」的微調。

---

## 三、垂直文字 180° 反轉、超出框

### 現象

- 編輯後垂直文字整行**反轉 180°**，或內容**超出文字框**。

### 嘗試的解法與失敗／新問題

| 嘗試 | 做法 | 結果／新問題 |
|------|------|--------------|
| 1 | 直接傳 PDF 的 rotation（例如 90）給 insert_htmlbox 的 rotate | **失敗**：方向與預期相反，出現 180° 反轉。 |
| 2 | 傳 **insert_rotate = (360 - rotation) % 360**（例如 90→270） | **有效**：方向正確，不再 180° 反轉。 |
| 3 | 為讓內容塞進框，對垂直文字做**寬高交換**（rect 的 width/height 互換） | **新問題**：繪製位置**右移**或與前一行重疊，使用者不滿。 |
| 4 | 垂直時不再寬高交換，改用**原 bbox 寬高**或**窄×高**（只擴高） | **有效**：位置正確；但窄 rect 易導致「塞不下」→ spare_height=-1 → 需 scale_low=0 fallback（見第一、二節）。 |

### 結論

- 旋轉方向需用 `(360 - rotation) % 360` 對應 insert_htmlbox。
- 垂直時 rect 維持窄×高、不交換寬高，以免位置錯亂；塞不下則依賴 fallback。

---

## 四、編輯後「一部分字保留、一部分字消失」（截斷、空格不見、只顯示「so」或「somesc」）

### 是否有發生過？當時是否有解決？

**有發生過**，且可細分為兩類：

1. **空格消失、其餘字保留**：編輯後字母在，但**空格**不見或壓成零寬（視覺上「一部分保留、一部分消失」）。
2. **字元截斷／錯亂**：例如「some song.」只顯示「**so**」或變成「**somesc**」（後半被截斷或與空格/換行異常混在一起），即**部分字保留、部分字消失或錯位**。

### 現象

- 編輯後「some song.」只顯示「so」或「somesc」；**空格**不見或壓成零寬。

### 嘗試的解法與失敗／新問題

| 嘗試 | 做法 | 結果／新問題 |
|------|------|--------------|
| 1 | 未特別處理空格 | **失敗**：在旋轉／窄框下空格容易被壓縮或丟失。 |
| 2 | 空格改為 **&#160;**（不換行空格）＋ 包在 `<span class="helv">` 內 | **已解決**：空格能穩定顯示，不再被壓成零寬。 |
| 3 | 截斷（「some song.」→「somesc」／只顯示「so」） | 與「框太小／塞不下」有關：框不夠大時引擎截斷或換行異常。透過**擴高** rect 與 **scale_low=0 fallback** 一併改善，**未單獨再改**；多數情況已隨 rect／fallback 減輕，若仍出現部分消失，可再檢查該區塊 rect 或 fallback 是否生效。 |

### 結論

- **空格「一部分消失」**：已解決（&#160; ＋ helv span）。
- **字元截斷／部分消失**：隨 rect 擴高與 scale_low fallback 一併改善，未做單獨專案修正；若再發生，優先確認該區塊是否為垂直文字、rect 是否過小、以及 spare_height&lt;0 時是否有執行 fallback。

---

## 五、換行時字級自動縮小

### 現象

- 內容有換行時，字級被自動縮小以塞進框。

### 嘗試的解法與失敗／新問題

| 嘗試 | 做法 | 結果／新問題 |
|------|------|--------------|
| 1 | 未設定 scale_low | **失敗**：引擎預設會縮小字級以 fit rect。 |
| 2 | 明確傳 **scale_low=1**（不允許縮小） | **有效**：字級不縮；但垂直時常導致 spare_height=-1（塞不下），故需 scale_low=0 fallback，fallback 時字級仍可能縮（見第二節）。 |

### 結論

- 先試 scale_low=1；垂直且 spare_height&lt;0 時再用 scale_low=0 保證有繪製，換行時字級在「第一次就塞得下」的情況下可維持不縮。

---

## 六、拓寬／重試邏輯與「不縮小字級」的衝突

### 現象

- 希望「行高不夠時拓寬文字框」、用「重新計算行高、拓寬框」取代縮小字級。

### 嘗試的解法與失敗／新問題

| 嘗試 | 做法 | 結果／新問題 |
|------|------|--------------|
| 1 | 依行數重新計算行高、**拓寬 rect 並重試**（例如最多 3 次） | **部分有效**：有時能塞入；但垂直時大幅拓寬（尤其改成正方形）會導致**旋轉後錯位、文字消失**（見第一節）。 |
| 2 | 改為「全部用 HTML、一次給足 rect」，**移除**拓寬重試 | **取捨**：邏輯簡化；垂直時改為「窄×高 ＋ scale_low=0 fallback」，不再依賴拓寬通過 scale_low=1。 |
| 3 | 非垂直且塞不下時：**不** fallback、直接 **raise 錯誤**，不縮小字級 | **有效**：水平時嚴格「不縮小字級」；垂直時為避免消失，仍保留 fallback。 |

### 結論

- 垂直文字不適合「一味拓寬 rect」以通過 scale_low=1，易導致錯位與消失。
- 水平：塞不下就報錯、不縮小；垂直：窄×高 ＋ spare_height&lt;0 時 scale_low=0 fallback。

---

## 七、總結：問題鏈與取捨

```
編輯後文字消失
  ← insert_htmlbox 回傳 -1 不繪製
  ← 垂直文字常回傳 -1
  ← 曾用大/正方形 rect 想讓 scale=1 通過 → 旋轉後錯位 → 仍「消失」

字級縮太多
  ← 為避免消失而用 scale_low=0 fallback
  ← 若不用 fallback → 又會消失
  ← 若用大 rect 讓 scale=1 通過 → 又易錯位消失

目前取捨
  • 垂直：窄×高 rect ＋ scale_low=0 fallback → 不消失、位置對，字級可能偏小
  • 水平：scale_low=1，塞不下就 raise，不縮小字級
  • 不改成正方形或大幅擴寬垂直 rect，避免旋轉後畫錯位置
```

---

## 八、相關文件

- **避免編輯後的文字消失.md**：根本原因、解決要點、檢查清單。
- **對話匯出_編輯後文字消失與垂直文字修正.md**：需求與修改歷程。
- **問題大全.md**（本檔）：反覆卡住的問題、嘗試、失敗與新問題。

---

*本檔依對話內容整理，供日後修改時避免重犯相同錯誤。*
